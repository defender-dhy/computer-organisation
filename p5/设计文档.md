 对于某一个指令的某一个数据需求，定义需求时间Tuse为：这条指令位于D级的时候，再经过多少个时钟周期就必须要使用相应的数据。

在P5课下要求的指令集的条件下，Tuse值有两个特点：

> - 特点1：是一个定值，每个指令的Tuse是一定的
> - 特点2：一个指令可以有两个Tuse值

对于某个指令的数据产出，我们定义供给时间Tnew为：位于某个流水级的某个指令，它经过多少个时钟周期可以算出结果并且存储到流水级寄存器里。

 在P5课下要求的指令集的条件下，Tnew值有两个特点：

> - 特点1：是一个动态值，每个指令处于流水线不同阶段有不同的Tnew值
> - 特点2：一个指令在一个时刻只会有一个Tnew值（一个指令只有一个结果）

|      | 转发接受位点 | Tuse      | Tnew |
| ---- | ------------ | --------- | ---- |
| addu | E@ALU        | 1         | D: 2 |
| beq  | D@cmp        | 0         | D: 1 |
| sw   | E@ALU  M@Dm  | rs=1,rt=2 | D: 2 |

| 转发输出 | 就近原则       |
| -------- | -------------- |
| DEreg    | j              |
| EMreg    | calc_i, calc_r |
| MWreg    | load           |

当两条指令发生数据冲突（前面指令的写入寄存器，等于后面指令的读取寄存器），我们就可以根据Tnew和Tuse值来判断策略。

> 1. Tnew=0，说明结果已经算出，如果指令处于WB级，则可以通过寄存器的内部转发设计解决，不需要任何操作。如果指令不处于WB级，则可以通过转发结果来解决。
> 2. Tnew<=Tuse，说明需要的数据可以及时算出，可以通过转发结果来解决。
> 3. Tnew>Tuse，说明需要的数据不能及时算出，必须暂停流水线解决。

## AT法

就是指通过在D级对指令的AT信息进行译码并流水，就可以方便地构造出数据冒险的处理机制。

分析需要转发的位点：当某一部件需要使用GPR（General Purpose Register）中的值时，如果此时这个值存在于后续某个流水线寄存器中，而还没来得及写入GPR，我们就需要通过转发（旁路）机制将这个值从流水线寄存器中送到该部件的输入处。

转发接收位点有：

1. D级比较器的两个输入（含NPC逻辑中寄存器值的输入）；
2. E级ALU的两个输入；
3. M级DM的输入。

## 阻塞

将指令暂停在D级时，我们需要进行如下操作：

- 冻结PC的值
- 冻结F/D级流水线寄存器的值
- 将D/E级流水线寄存器清零（这等价于插入了一个nop指令）